name: UIC Manifest Diff

on:
  pull_request:
    branches: [main]

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: uic-diff-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  manifest-diff:
    name: Manifest Diff
    runs-on: ubuntu-latest
    steps:
      # -- 1. Check out the HEAD (PR) branch and build/scan ----------------
      - name: Checkout PR head
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          path: head

      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm
          cache-dependency-path: head/pnpm-lock.yaml

      - name: Install and build (head)
        working-directory: head
        run: |
          pnpm install --frozen-lockfile
          pnpm build

      - name: Scan fixtures (head)
        working-directory: head
        run: npx uic scan fixtures/react-app -o /tmp/head-manifest.json

      # -- 2. Check out the BASE branch and build/scan ---------------------
      - name: Checkout base branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.base.sha }}
          path: base

      - name: Install and build (base)
        working-directory: base
        run: |
          pnpm install --frozen-lockfile
          pnpm build

      - name: Scan fixtures (base)
        working-directory: base
        run: npx uic scan fixtures/react-app -o /tmp/base-manifest.json

      # -- 3. Run diff and post PR comment ---------------------------------
      - name: Run uic diff
        id: diff
        working-directory: head
        continue-on-error: true
        run: |
          set +e
          DIFF_OUTPUT=$(npx uic diff /tmp/base-manifest.json /tmp/head-manifest.json 2>&1)
          EXIT_CODE=$?
          echo "exit_code=$EXIT_CODE" >> "$GITHUB_OUTPUT"
          {
            echo "diff_output<<DIFF_EOF"
            echo "$DIFF_OUTPUT"
            echo "DIFF_EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Post PR comment
        uses: actions/github-script@v7
        env:
          DIFF_OUTPUT: ${{ steps.diff.outputs.diff_output }}
          DIFF_EXIT_CODE: ${{ steps.diff.outputs.exit_code }}
        with:
          script: |
            const diffOutput = process.env.DIFF_OUTPUT || 'No diff output captured.';
            const exitCode = process.env.DIFF_EXIT_CODE || '0';
            const status = exitCode === '0' ? 'No breaking changes' : 'Breaking changes detected';
            const icon = exitCode === '0' ? ':white_check_mark:' : ':warning:';

            const body = [
              `## ${icon} UIC Manifest Diff`,
              '',
              `**Status:** ${status}`,
              '',
              '```',
              diffOutput,
              '```',
              '',
              '_Generated by [uic diff](https://github.com/sherifkozman/uicontract) in CI._',
            ].join('\n');

            // Find existing UIC comment to update (avoid spam)
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            const existing = comments.find(c => c.body?.includes('UIC Manifest Diff'));

            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body,
              });
            }
